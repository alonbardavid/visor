/**visor
* Angular authentication and authorization library
* @version v0.0.1
* @link  https://github.com/illniyar/visor
* @license MIT License, http://www.opensource.org/licenses/MIT
*/

"undefined"!=typeof module&&"undefined"!=typeof exports&&module.exports===exports&&(module.exports="visor"),function(a,b,c){!function(){"use strict";b.module("delayLocationChange",[]).service("delayLocationChange",["$rootScope","$q","$timeout","$location","$injector",function(a,b,c,d,e){function f(){l--,n&&0>=l&&g()}function g(){d.absUrl()===i?a.$broadcast("$locationChangeSuccess",i,j):d.url(k)}function h(a){l++,a.finally(f)}var i,j,k,l=0,m=[],n=!1,o=function(a){a.then?h(a):n?h(e.invoke(fn)):m.push(a)},p=a.$on("$locationChangeStart",function(a,b,g){n=!0,k=d.url(),p(),a.preventDefault(),m.forEach(function(a){h(e.invoke(a))}),0!==l||i||(l++,c(f,1)),i=b,j=g});return o}])}(),function(){"use strict";b.module("visor",["visor.permissions","visor.ui-router","visor.ngRoute","delayLocationChange"]).constant("authenticatedOnly",function(a){return!!a}).constant("notForAuthenticated",function(a){return a===c}).provider("visor",[function(){function a(a,c,d){return b.shouldAddNext?a.indexOf("?")>=0?a.replace(/\?/,"?next="+encodeURIComponent(d)+"&"):a+"?next="+encodeURIComponent(d):a}var b=this;b.authenticateOnStartup=!0,b.loginRoute="/login",b.homeRoute="/",b.notAuthorizedRoute="/access_denied",b.shouldAddNext=!0,b.authenticate=function(){throw new Error("visorProvider.authenticate must be defined to use visor")},b.doOnNotAuthenticated=["$location","restrictedUrl",function(c,d){c.url(a(b.loginRoute,c,d))}],b.doAfterManualAuthentication=["$location",function(a){a.url(a.search().next||b.homeRoute)}],b.doOnNotAuthorized=["$location",function(a){a.url(b.notAuthorizedRoute)}],this.$get=["$injector","$q","$rootScope","$location","visorPermissions",function(a,d,e,f,g){function h(a){k.authData=a,g.invokeParameters=[k.authData]}function i(){k.authData=c,g.invokeParameters=[]}var j=!1,k={authenticate:function(c){if(j&&!c)return j;var e=d.defer();return j=e.promise,a.invoke(b.authenticate).then(h,i).finally(function(){e.resolve(k.authData)}),e.promise},setAuthenticated:function(c){h(c),j=d.when(c),a.invoke(b.doAfterManualAuthentication,null,{authData:c})},isAuthenticated:function(){return!!k.authData},doOnNotAllowed:function(c){k.isAuthenticated()?a.invoke(b.doOnNotAuthorized,null,{restrictedUrl:c}):a.invoke(b.doOnNotAuthenticated,null,{restrictedUrl:c})},setUnauthenticated:function(){i()},config:b};return k}]}]).run(["visor","delayLocationChange",function(a,b){a.config.authenticateOnStartup&&b(a.authenticate())}]).config(["visorPermissionsProvider",function(a){a.doBeforeFirstCheck.push(["visor",function(a){return a.authenticate()}]),a.onNotAllowed=["visor","restrictedUrl",function(a,b){a.doOnNotAllowed(b)}]}])}(),function(){b.module("visor.ngRoute",["visor.permissions"]).run(["$rootScope","visorPermissions","$injector",function(a,b,c){var d=!1;try{c.get("$route"),d=!0}catch(e){}d&&a.$on("$routeChangeStart",function(a,c){c.resolve=c.resolve||{},b.onRouteChange(c,function(a){c.resolve._visorDelay=function(){return a}})})}])}(),function(){b.module("visor.permissions",[]).provider("visorPermissions",[function(){var a=this;a.getPermissionsFromNext=function(a){return a.restrict?[a.restrict]:[]},a.doBeforeFirstCheck=[],a.onNotAllowed=function(){},a.invokeParameters=[];var b=!1;this.$get=["$q","$injector","$location",function(c,d,e){function f(b,c){var d=!0;return c.forEach(function(a){d=d&&a.apply(null,g.invokeParameters)}),d?!0:(g.invokeNotAllowed(a.onNotAllowed),!1)}var g={onRouteChange:function(e,h){var i=g.getPermissionsFromNext(e);if(!i||0==i.length)return!0;if(b)return f(e,i);var j=c.defer();return h(j.promise),c.all(a.doBeforeFirstCheck.map(function(a){return d.invoke(a)})).finally(function(){b=!0,f(e,i)?j.resolve(!0):j.reject(!1)}),"delayed"},getPermissionsFromNext:a.getPermissionsFromNext,invokeParameters:a.invokeParameters,invokeNotAllowed:function(a){d.invoke(a,null,{restrictedUrl:e.url()})}};return g}]}])}(),function(){b.module("visor.ui-router",["visor.permissions"]).run(["$rootScope","visorPermissions","$injector","$timeout","$location",function(a,b,c,d,e){var f=!1;try{c.get("$state"),f=!0}catch(g){}if(f){c.invoke(["$state",function(a){b.getPermissionsFromNext=function(b){for(var c=[];b;)b.restrict&&c.unshift(b.restrict),b=b.parent?a.get(b.parent):b.name.indexOf(".")>0?a.get(b.name.replace(/(.*\.)?([^.]+)\.[^.]*$/,"$2")):null;return c}}]);var h=c.get("$urlRouter");a.$on("$stateChangeStart",function(a,c){var d=b.onRouteChange(c,function(b){a.preventDefault();var c=e.url();b.then(function(){e.url()===c?h.sync():(e.url(c),h.sync())})});d||a.preventDefault()}),b.invokeNotAllowed=function(a){var b=e.url();d(function(){c.invoke(a,null,{restrictedUrl:b})},0)}}}])}()}(window,window.angular);